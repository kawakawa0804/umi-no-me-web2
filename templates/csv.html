<!doctype html>
<html lang="ja">
<head>
  <!-- Favicon (PNG) -->
<link rel="icon" type="image/x-icon" href="../static/img/favicon.ico?v=1">
<link rel="apple-touch-icon" href="../static/img/favicon.ico?v=1">


  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Umi no Me | 検出ログ</title>
  <link rel="icon" type="image/x-icon" href="/static/img/favicon.ico?v=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <style>
    :root { color-scheme: dark light; }
    body { font-family: 'Noto Sans JP', system-ui, sans-serif; background:#0f172a; color:#e5e7eb; }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    a.btn { display:inline-block; padding:8px 14px; border:1px solid #ffffff22; border-radius:12px; color:#e5e7eb; text-decoration:none; }
    a.btn:hover { background:#ffffff14; }
    h1 { font-size:20px; margin: 0 0 14px; }
    #csvTable { width:100%; background:#111827; }
    table.dataTable thead th { color:#cfeeff; }
  </style>

  <script>
  (function(){
    const qs = new URLSearchParams(location.search).get('api');
    const ls = localStorage.getItem('API_BASE');
    window.API_BASE = qs || ls || 'http://127.0.0.1:8000';
    if (qs) localStorage.setItem('API_BASE', window.API_BASE);
  })();
  </script>
</head>
<body>
  <div class="wrap">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;">
      <h1>検出ログ（CSVビュー）</h1>
      <div style="display:flex; gap:8px; align-items:center;">
        <span style="font-size:12px; opacity:.8;">API: <code id="apiLabel"></code></span>
        <a class="btn" href="../index.html">戻る</a>
      </div>
    </div>
    <table id="csvTable" class="display"></table>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script>
  (async function () {
    document.getElementById('apiLabel').textContent = window.API_BASE;

    function pad(n){ return n<10 ? '0'+n : ''+n; }
    function fmt(ts){
      try{
        const d = new Date(ts);
        const y = d.getFullYear();
        const m = pad(d.getMonth()+1);
        const dd = pad(d.getDate());
        const hh = pad(d.getHours());
        const mm = pad(d.getMinutes());
        return `${y}/${m}/${dd} ${hh}:${mm}`;
      }catch(_){ return ts; }
    }

    let data = [];
    try{
      const res = await fetch(`${window.API_BASE}/csv-data`);
      if(!res.ok) throw new Error(await res.text());
      data = await res.json();
    }catch(e){
      alert('CSVデータ取得に失敗しました: ' + (e.message || e));
      data = [];
    }

    if (Array.isArray(data) && data.length) {
      data = data.map(row => {
        const r = {...row};
        const k = Object.keys(r).find(key => /time|timestamp|ts/i.test(key)) || 'timestamp';
        if (r[k]) r[k] = fmt(r[k]);
        return r;
      });
    }

    const columns = (() => {
      const sample = data[0] || { timestamp:'', class:'', confidence:'' };
      return Object.keys(sample).map(k => ({ title:k, data:k }));
    })();

    $('#csvTable').DataTable({
      data,
      columns,
      paging: true,
      searching: true,
      order: [[0, 'desc']],
      language: { url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/ja.json' }
    });
  })();
  </script>
</body>
</html>
