<!doctype html>
<html lang="ja">
<head>
  <!-- ★ Favicon（キャッシュ破り付き） -->
  <link rel="icon" href="./static/img/favicon.ico?v=20251023">
  <link rel="shortcut icon" href="./static/img/favicon.ico?v=20251023">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Umi no Me | 海の目</title>
  <meta name="description" content="Umi no Me — 海のゴミと生物を検知して見える化するデモUI" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- API_BASE を URL ?api= または localStorage から初期化 -->
  <script>
  (function(){
    var qs = new URLSearchParams(location.search).get('api');
    var ls = localStorage.getItem('API_BASE');
    window.API_BASE = qs || ls || 'http://127.0.0.1:8000';
    if (qs) localStorage.setItem('API_BASE', window.API_BASE);
  })();
  </script>

  <style>
    :root { color-scheme: dark light; }
    .glass { backdrop-filter: blur(12px); background: color-mix(in oklab, white 6%, transparent); }
    .ocean-hero { background-image: linear-gradient(to bottom, rgba(3,7,18,.45), rgba(3,7,18,.6)), url('https://images.unsplash.com/photo-1505761671935-60b3a7427bad?q=80&w=2400&auto=format&fit=crop'); background-size:cover; background-position:center; }
    .grid-bg { background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,.08) 1px, transparent 0); background-size:20px 20px; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans">
  <!-- Header -->
  <header class="sticky top-0 z-40 border-b border-white/10 backdrop-blur bg-slate-950/60">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <a href="#" class="flex items-center gap-3">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" class="drop-shadow-glow">
          <path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6S2 12 2 12Z" stroke="#45b6ff" stroke-width="1.5"/>
          <circle cx="12" cy="12" r="3.2" fill="#1fa4ff"/>
          <path d="M4 16c2.2-1.2 4.5 1.2 6.9 1.2 2.4 0 4.7-2.4 7.1-1.2" stroke="#1fa4ff" stroke-width="1.2" stroke-linecap="round"/>
        </svg>
        <div>
          <div class="text-lg font-extrabold tracking-tight">Umi no Me</div>
          <div class="text-xs text-slate-300/80 -mt-1">海の目 • Marine AI</div>
        </div>
      </a>
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#features" class="hover:text-umiblue-300 transition">特徴</a>
        <a href="#demo" class="hover:text-umiblue-300 transition">デモ</a>
        <a href="#model" class="hover:text-umiblue-300 transition">モデル</a>
        <a href="#roadmap" class="hover:text-umiblue-300 transition">ロードマップ</a>
      </nav>
      <div class="flex items-center gap-3">
        <button id="openDemo" class="px-4 py-2 rounded-2xl bg-umiblue-500 hover:bg-umiblue-400 transition font-semibold shadow">デモを開く</button>
        <a href="https://github.com/kawakawa0804/umi-no-me-web2" target="_blank" rel="noreferrer" class="px-4 py-2 rounded-2xl border border-white/15 hover:border-umiblue-400/60 transition">GitHub</a>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="ocean-hero relative">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="py-20 md:py-28 flex flex-col md:flex-row items-center gap-10">
        <div class="md:w-3/5">
          <h1 class="text-4xl md:text-6xl font-extrabold leading-tight drop-shadow-glow">海を、<span class="text-umiblue-300">見える化</span>する。<br>Umi no Me</h1>
          <p class="mt-6 text-slate-200/90 text-lg md:text-xl max-w-2xl">海洋ごみと生物をリアルタイム検知。現場意思決定から回収ロボット連携まで。</p>
          <div class="mt-8">
            <a href="#features" class="inline-block px-5 py-3 rounded-2xl border border-white/15 hover:border-umiblue-400/60">特徴を見る</a>
          </div>
          <div class="mt-6 text-xs text-slate-300/80">※ UIはブラウザ/サーバ推論どちらにも対応できる設計。</div>
        </div>
        <div class="md:w-2/5 w-full">
          <div class="glass rounded-2xl p-4 border border-white/10 shadow-lg grid-bg">
            <div class="aspect-video rounded-xl bg-black/50 border border-white/10 flex items-center justify-center relative overflow-hidden">
              <img src="https://images.unsplash.com/photo-1500375592092-40eb2168fd21?q=80&w=1800&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-60" alt="">
              <div class="relative z-10 text-center">
                <div class="text-sm uppercase tracking-widest text-umiblue-300">Live Overlay</div>
                <div class="mt-1 text-2xl font-bold">Detection View</div>
                <div class="mt-3 text-xs text-slate-300/80">（サンプル）
                  <span class="ml-2 inline-flex items-center gap-1 px-2 py-1 rounded-full bg-umiblue-500/20 border border-umiblue-400/30">bottle 0.87</span>
                  <span class="ml-2 inline-flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-500/20 border border-emerald-400/30">fish 0.76</span>
                </div>
              </div>
              <div class="absolute inset-0">
                <div class="absolute left-[14%] top-[20%] w-[38%] h-[46%] border-2 border-umiblue-400 rounded-md"></div>
                <div class="absolute right-[16%] bottom-[18%] w-[24%] h-[30%] border-2 border-emerald-400 rounded-md"></div>
              </div>
            </div>
            <div class="mt-3 text-right text-xs text-slate-300/80">カメラ/動画/画像に対応</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Features -->
  <section id="features" class="py-20 bg-slate-950">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-3xl md:text-4xl font-extrabold">Umi no Me の特長</h2>
      <p class="mt-2 text-slate-300/90">AIで海洋ごみと生物を高精度に識別する軽量システム。</p>

      <div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="p-5 rounded-2xl border border-white/10 bg-white/5">
          <div class="font-semibold">高精度な検出</div>
          <p class="mt-2 text-sm text-slate-300/80">生物／プラスチック（ボトル・袋・缶・ガラス等）をYOLO系で判別。誤検出を低減。</p>
        </div>
        <div class="p-5 rounded-2xl border border-white/10 bg-white/5">
          <div class="font-semibold">軽量・低コスト</div>
          <p class="mt-2 text-sm text-slate-300/80">ノートPC／ラズパイでも動作。現場運用を想定した負荷設計。</p>
        </div>
        <div class="p-5 rounded-2xl border border-white/10 bg-white/5">
          <div class="font-semibold">記録と可視化</div>
          <p class="mt-2 text-sm text-slate-300/80">検出結果をCSV保存。後から傾向分析や地図化へ展開可能。</p>
        </div>
        <div class="p-5 rounded-2xl border border-white/10 bg-white/5">
          <div class="font-semibold">教育利用</div>
          <p class="mt-2 text-sm text-slate-300/80">探究学習教材としても活用できるUI設計。</p>
        </div>
      </div>
    </div>
  </section>

  <!-- How -->
  <section id="how" class="py-20 bg-slate-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-3xl md:text-4xl font-extrabold">仕組み</h2>
    <ol class="mt-6 space-y-3 text-slate-300/90 list-decimal list-inside">
        <li>カメラ／動画／画像からフレームを取得しCanvasに描画</li>
        <li>CanvasをJPEG化して <code>API_BASE/api/detect</code> にPOST</li>
        <li>レスポンスの <code>detections</code> を枠・ラベルでオーバーレイ表示</li>
        <li>CSVに保存して分析・可視化へ活用（別ページで閲覧）</li>
      </ol>
    </div>
  </section>

  <!-- Model -->
  <section id="model" class="py-20 bg-slate-950">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-3xl md:text-4xl font-extrabold">モデル</h2>
      <p class="mt-2 text-slate-300/90">現在の運用モデルは <code>/Users/fugutapc/umi-no-me-web-clean/models/best.pt</code> です。選択するとデモAPIの <code>model</code> パラメータに反映されます。</p>

      <!-- モデル選択（1択＋Auto） -->
      <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <label class="flex items-start gap-3 p-4 rounded-2xl border border-white/10 bg-white/5 cursor-pointer">
          <input type="radio" name="modelName" value="auto" class="mt-1 accent-umiblue-500" checked>
          <div>
            <div class="font-semibold">Auto（サーバデフォルト）</div>
            <div class="text-sm text-slate-300/80">API側の既定モデルを使用（指定なし）。</div>
          </div>
        </label>
        <label class="flex items-start gap-3 p-4 rounded-2xl border border-white/10 bg-white/5 cursor-pointer">
          <input type="radio" name="modelName" value="/Users/fugutapc/umi-no-me-web-clean/models/best.pt" class="mt-1 accent-umiblue-500">
          <div>
            <div class="font-semibold">best.pt（ローカル）</div>
            <div class="text-sm text-slate-300/80">フルパスをAPIへ渡して推論します。</div>
          </div>
        </label>
      </div>

      <!-- グラフ2枚 -->
      <div class="mt-10 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <figure class="rounded-2xl overflow-hidden border border-white/10 bg-white/5">
          <!-- ★ この画像を ./static/img/data-trend.png に置いてください -->
          <img src="./static/img/き.png"   alt="データ量と精度の推移" class="w-full h-auto block">
          <figcaption class="text-sm text-slate-300/80 p-3">図1. データ量とmAPの推移</figcaption>
        </figure>
        <figure class="rounded-2xl overflow-hidden border border-white/10 bg-white/5">
          <!-- ★ この画像を ./static/img/map-pie.png に置いてください -->
          <img src="./static/img/ふぇ.png" alt="Umi no Me Ver.2.3のmAP割合" class="w-full h-auto block">
          <figcaption class="text-sm text-slate-300/80 p-3">図2. Ver.2.3 クラス別mAP割合</figcaption>
        </figure>
      </div>
    </div>
  </section>

  <!-- Roadmap（空枠：後で入れる） -->
  <section id="roadmap" class="py-20 bg-slate-900 hidden"></section>

  <!-- Demo Modal -->
  <div id="demo" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative max-w-5xl mx-auto mt-16 mb-10 p-4">
      <div class="glass rounded-2xl border border-white/10 overflow-hidden">
        <div class="p-4 border-b border-white/10 flex items-center justify-between">
          <div class="font-semibold">デモ（カメラ/動画/画像 → サーバ推論）</div>
          <button id="closeDemo" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm">閉じる</button>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3">
          <!-- Controls -->
          <div class="p-4 space-y-4 border-b lg:border-b-0 lg:border-r border-white/10">
            <div>
              <div class="text-sm text-slate-300/90 mb-1">入力ソース</div>
              <div class="grid grid-cols-3 gap-2">
                <button data-src="camera" class="srcBtn px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm">カメラ</button>
                <label class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm text-center cursor-pointer">動画
                  <input id="videoInput" type="file" accept="video/*" class="hidden" />
                </label>
                <label class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm text-center cursor-pointer">画像
                  <input id="imageInput" type="file" accept="image/*" class="hidden" />
                </label>
              </div>
            </div>
            <div>
              <div class="text-sm text-slate-300/90 mb-1">描画設定</div>
              <div class="flex items-center justify-between text-sm">
                <label class="flex items-center gap-2"><input id="showBoxes" type="checkbox" class="accent-umiblue-500" checked>バウンディング</label>
                <label class="flex items-center gap-2"><input id="showLabels" type="checkbox" class="accent-umiblue-500" checked>ラベル</label>
              </div>
            </div>
            <div>
              <div class="text-sm text-slate-300/90 mb-1">ログ</div>
              <div id="log" class="h-28 p-2 bg-black/40 rounded-xl border border-white/10 text-xs overflow-auto">準備中…</div>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
              <button id="startDemo" class="px-4 py-2 rounded-2xl bg-umiblue-500 hover:bg-umiblue-400 font-semibold">スタート（実行）</button>
              <button id="stopDemo" class="px-4 py-2 rounded-2xl border border-white/10 hover:bg-white/10">停止</button>
              <button id="exportCSV" class="px-4 py-2 rounded-2xl border border-white/10 hover:bg-white/10">CSV出力</button>
            </div>
          </div>
          <!-- Viewport -->
          <div class="lg:col-span-2 bg-black/60 relative">
            <div id="waiting" class="absolute inset-0 flex items-center justify-center text-slate-300/60 text-sm">入力待ち…</div>
            <video id="video" class="hidden" playsinline muted></video>
            <canvas id="canvas" class="block w-full h-full"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="py-10 border-t border-white/10 bg-slate-950 text-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row items-center justify-between gap-4">
      <div>© <span id="year"></span> Umi no Me</div>
      <div class="text-slate-300/80">Made with ❤ to keep our ocean clean.</div>
    </div>
  </footer>

  <!-- ========= JS ========= -->
  <script>
  // util
  var $  = function(q){ return document.querySelector(q); };
  var $$ = function(q){ return Array.prototype.slice.call(document.querySelectorAll(q)); };
  var log = function(m){
    var el = $('#log'); if(!el) return;
    el.textContent += '\n' + new Date().toLocaleTimeString() + '  ' + m;
    el.scrollTop = el.scrollHeight;
  };
  $('#year').textContent = new Date().getFullYear();

  function toggleDemo(show){
    var c = document.getElementById('demo').classList;
    if (show) { c.remove('hidden'); prepareDemo(); }
    else { c.add('hidden'); stopAll(); }
  }

  // ヘッダーの「デモを開く」/ ナビ「デモ」＋スムーススクロール
  (function(){
    var btnOpen = document.getElementById('openDemo');
    if (btnOpen) btnOpen.addEventListener('click', function(){ toggleDemo(true); });
    var closeBtn = document.getElementById('closeDemo');
    if (closeBtn) closeBtn.addEventListener('click', function(){ toggleDemo(false); });

    function smoothGo(id){
      var el = document.querySelector(id);
      if (!el) return;
      var header = document.querySelector('header');
      var offset = header ? header.offsetHeight + 10 : 70;
      var y = el.getBoundingClientRect().top + window.pageYOffset - offset;
      window.scrollTo({ top: y, behavior: 'smooth' });
    }
    var demoNav = document.querySelector('nav a[href="#demo"]');
    if (demoNav) demoNav.addEventListener('click', function(e){ e.preventDefault(); toggleDemo(true); });

    var navLinks = document.querySelectorAll('nav a[href^="#"]:not([href="#demo"])');
    for (var i = 0; i < navLinks.length; i++) {
      (function(a){
        a.addEventListener('click', function(e){
          e.preventDefault();
          smoothGo(a.getAttribute('href'));
        });
      })(navLinks[i]);
    }
  })();

  // ===== デモ本体 =====
  var canvas = $('#canvas');
  var ctx = canvas.getContext('2d');
  var video = $('#video');
  var playing=false, detectTimer=null, currentSrc='camera';

  function resizeCanvas(){
    var box = canvas.parentElement.getBoundingClientRect();
    canvas.width  = Math.max(320, Math.floor(box.width));
    canvas.height = Math.max(180, Math.floor(box.height));
  }
  window.addEventListener('resize', function(){
    if(!document.getElementById('demo').classList.contains('hidden')) resizeCanvas();
  });

  $$('.srcBtn').forEach(function(b){
    b.addEventListener('click', function(){
      currentSrc = b.getAttribute('data-src');
      startSource();
    });
  });

  var imageInput = document.getElementById('imageInput');
  if (imageInput) {
    imageInput.addEventListener('change', function(e){
      var f = e.target.files && e.target.files[0]; if(!f) return;
      var img = new Image();
      img.onload = function(){
        document.getElementById('waiting').classList.add('hidden');
        resizeCanvas();
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        log('画像: ' + f.name);
      };
      img.src = URL.createObjectURL(f);
    });
  }

  var videoInput = document.getElementById('videoInput');
  if (videoInput) {
    videoInput.addEventListener('change', function(e){
      var f = e.target.files && e.target.files[0]; if(!f) return;
      document.getElementById('waiting').classList.add('hidden');
      resizeCanvas();
      var url = URL.createObjectURL(f);
      video.src = url; video.muted = true; video.playsInline = true;
      video.onloadeddata = function(){ video.play(); animate(); log('動画: ' + f.name); };
    });
  }

  async function startSource(){
    if(currentSrc!=='camera') return;
    try{
      var stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
      video.srcObject = stream; video.muted = true; video.playsInline = true; await video.play();
      document.getElementById('waiting').classList.add('hidden');
      resizeCanvas(); playing=true; animate(); log('カメラ開始');
    }catch(e){ log('カメラ権限エラー: ' + (e.message||e)); }
  }

  function stopAll(){
    playing=false;
    if(detectTimer){ clearInterval(detectTimer); detectTimer=null; }
    if(video.srcObject){ video.srcObject.getTracks().forEach(function(t){ t.stop(); }); video.srcObject=null; }
    log('停止');
  }

  function animate(){
    if(document.getElementById('demo').classList.contains('hidden')) return;
    if(video.readyState>=2){
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      if(window.lastResult) drawOverlay(window.lastResult);
    }
    if(playing) requestAnimationFrame(animate);
  }

  // === detectFromCanvas: model= を自動付与 ===
  async function detectFromCanvas(){
    try{
      var blob = await new Promise(function(res){ canvas.toBlob(res,'image/jpeg',0.9); });
      if(!blob) throw new Error('canvas.toBlob failed');
      var fd = new FormData(); fd.append('image', new File([blob],'frame.jpg',{type:'image/jpeg'}));

      // model パラメータ付与（autoのときは付けない）
      var url = window.API_BASE + '/api/detect?conf=0.12&iou=0.50';
      if (window.MODEL_NAME && window.MODEL_NAME !== 'auto') {
        url += '&model=' + encodeURIComponent(window.MODEL_NAME);
      }

      var t0 = performance.now();
      var r = await fetch(url, {method:'POST', body:fd});
      if(!r.ok){ var tx = await r.text(); throw new Error(r.status + ' ' + r.statusText + ': ' + tx); }
      var data = await r.json(); window.lastResult = data;
      var t1 = performance.now(); log('検出: ' + (data.detections ? data.detections.length : 0) + '件 / ' + (t1-t0).toFixed(0) + 'ms');
    }catch(e){
      log('検出エラー: ' + (e && e.message ? e.message : e));
      window.lastResult=null;
    }
  }

  function drawOverlay(data){
    var showBoxes = document.getElementById('showBoxes') ? document.getElementById('showBoxes').checked : true;
    var showLabels = document.getElementById('showLabels') ? document.getElementById('showLabels').checked : true;
    if(!data || !data.detections || !data.detections.length || (!showBoxes && !showLabels)) return;
    var sx = canvas.width / data.width, sy = canvas.height / data.height;
    ctx.save();
    for(var i=0;i<data.detections.length;i++){
      var d = data.detections[i];
      var x1=d.box_xyxy[0], y1=d.box_xyxy[1], x2=d.box_xyxy[2], y2=d.box_xyxy[3];
      var X1=x1*sx, Y1=y1*sy, W=(x2-x1)*sx, H=(y2-y1)*sy;
      if(showBoxes){
        ctx.lineWidth = Math.max(2, Math.min(W,H)*0.01);
        ctx.strokeStyle='#45b6ff';
        ctx.shadowColor='rgba(0,0,0,.6)'; ctx.shadowBlur=6;
        ctx.strokeRect(X1,Y1,W,H); ctx.shadowBlur=0;
      }
      if(showLabels){
        var label = d['class'] + ' ' + d.conf.toFixed(2);
        ctx.font='13px system-ui';
        var padH=6, padV=4;
        var tw=ctx.measureText(label).width+padH*2, th=18+padV;
        var bx=X1, by=Math.max(0, Y1-th-2);
        ctx.fillStyle='rgba(4,58,99,.9)'; ctx.fillRect(bx,by,tw,th);
        ctx.fillStyle='#e6f5ff'; ctx.fillText(label, bx+padH, by+th-6);
      }
    }
    ctx.restore();
  }

  function prepareDemo(){ resizeCanvas(); document.getElementById('waiting').classList.remove('hidden'); log('UI準備完了'); }
  var startDemoBtn = document.getElementById('startDemo');
  if (startDemoBtn) {
    startDemoBtn.addEventListener('click', async function(){
      if(playing) return; playing=true; await startSource(); if(!detectTimer) detectTimer=setInterval(detectFromCanvas,500);
    });
  }
  var stopDemoBtn = document.getElementById('stopDemo');
  if (stopDemoBtn) {
    stopDemoBtn.addEventListener('click', function(){ stopAll(); });
  }

  // CSVページ遷移（API引き継ぎ）
  (function(){
    var btn = document.getElementById('exportCSV');
    if (!btn) return;
    var api = window.API_BASE ? ('?api=' + encodeURIComponent(window.API_BASE)) : '';
    var target;
    if (String(location.hostname).slice(-9) === 'github.io') {
      target = 'https://' + location.hostname + '/umi-no-me-web2/templates/csv.html' + api;
    } else {
      target = new URL('templates/csv.html' + api, location.href).toString();
    }
    var clone = btn.cloneNode(true);
    clone.addEventListener('click', function(e){ e.preventDefault(); window.location.href = target; });
    btn.replaceWith(clone);
  })();

  // === Model selector: localStorageと連動 ===
  (function(){
    var key = 'MODEL_NAME';
    var saved = localStorage.getItem(key) || 'auto';
    window.MODEL_NAME = saved;

    var radios = document.querySelectorAll('input[name="modelName"]');
    for (var i=0;i<radios.length;i++){
      if (radios[i].value === saved) radios[i].checked = true;
      radios[i].addEventListener('change', function(e){
        if (!e.target || !e.target.value) return;
        window.MODEL_NAME = e.target.value;
        localStorage.setItem(key, window.MODEL_NAME);
        log('モデル切替: ' + window.MODEL_NAME);
      });
    }
  })();
  </script>
</body>
</html>
